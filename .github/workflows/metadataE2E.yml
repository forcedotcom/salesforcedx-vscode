name: Metadata E2E (Playwright)

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'packages/salesforcedx-vscode-metadata/**'
      - 'packages/salesforcedx-vscode-services/**'
      - 'packages/playwright-vscode-ext/**'
      - '.github/workflows/metadataE2E.yml'

jobs:
  e2e-web:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      DREAMHOUSE_ORG_ALIAS: orgBrowserDreamhouseTestOrg
      MINIMAL_ORG_ALIAS: minimalTestOrg
      SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL_E2E }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install Salesforce CLI
        run: |
          npm i -g @salesforce/cli

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers and OS deps
        run: npx playwright install chromium --with-deps

      - name: Clone dreamhouse
        shell: bash
        run: git clone --depth=1 https://github.com/trailheadapps/dreamhouse-lwc dreamhouse-lwc

      - name: create scratch org and set up dreamhouse
        # the tests expect a scratch org with dreamhouse at a certain alias but don't use the directory directly
        shell: bash
        run: |
          echo "$SFDX_AUTH_URL" | sf org login sfdx-url --set-default-dev-hub --sfdx-url-stdin
          sf org create scratch -y 1 -d -f config/project-scratch-def.json -a "$DREAMHOUSE_ORG_ALIAS" --json --wait 30
          sf project deploy start
          sf org assign permset -n dreamhouse
        working-directory: dreamhouse-lwc

      - name: Generate minimal project
        shell: bash
        run: sf project generate -n minimal-project

      - name: create scratch org
        # the tests expect a scratch org with a certain alias but don't use the directory directly
        shell: bash
        run: |
          echo "$SFDX_AUTH_URL" | sf org login sfdx-url --set-default-dev-hub --sfdx-url-stdin
          sf org create scratch -y 1 -d -f config/project-scratch-def.json -a "$MINIMAL_ORG_ALIAS" --json  --wait 30
        working-directory: minimal-project

      - name: Run Metadata headless tests (headless config)
        env:
          DREAMHOUSE_ORG_ALIAS: orgBrowserDreamhouseTestOrg
          MINIMAL_ORG_ALIAS: minimalTestOrg
          CI: 1
        # compile the entire project to
        run: |
          npm run test:web -w salesforcedx-vscode-metadata -- --reporter=html

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-web
          path: packages/salesforcedx-vscode-metadata/playwright-report
          if-no-files-found: ignore

      - name: Upload Playwright Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results-web
          path: packages/salesforcedx-vscode-metadata/test-results
          if-no-files-found: ignore

      - name: Cleanup scratch orgs
        if: always()
        continue-on-error: true
        run: |
          sf org delete scratch -o "$DREAMHOUSE_ORG_ALIAS" --no-prompt || true
          sf org delete scratch -o "$MINIMAL_ORG_ALIAS" --no-prompt || true

  e2e-desktop:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      matrix:
        os: [macos-latest, windows-latest]
      fail-fast: false

    env:
      DREAMHOUSE_ORG_ALIAS: orgBrowserDreamhouseTestOrg
      MINIMAL_ORG_ALIAS: minimalTestOrg
      SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL_E2E }}
      VSCODE_DESKTOP: 1
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install Salesforce CLI
        run: |
          npm i -g @salesforce/cli

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers and OS deps
        run: npx playwright install chromium --with-deps

      - name: Clone dreamhouse
        shell: bash
        run: git clone --depth=1 https://github.com/trailheadapps/dreamhouse-lwc dreamhouse-lwc

      - name: create scratch org and set up dreamhouse
        # the tests expect a scratch org with dreamhouse at a certain alias but don't use the directory directly
        shell: bash
        run: |
          echo "$SFDX_AUTH_URL" | sf org login sfdx-url --set-default-dev-hub --sfdx-url-stdin
          sf org create scratch -y 1 -d -f config/project-scratch-def.json -a "$DREAMHOUSE_ORG_ALIAS" --json --wait 30
          sf project deploy start
          sf org assign permset -n dreamhouse
        working-directory: dreamhouse-lwc

      - name: Generate minimal project
        shell: bash
        run: sf project generate -n minimal-project

      - name: create scratch org
        # the tests expect a scratch org with a certain alias but don't use the directory directly
        shell: bash
        run: |
          echo "$SFDX_AUTH_URL" | sf org login sfdx-url --set-default-dev-hub --sfdx-url-stdin
          sf org create scratch -y 1 -d -f config/project-scratch-def.json -a "$MINIMAL_ORG_ALIAS" --json --wait 30
        working-directory: minimal-project

      - name: Run Metadata headless tests (headless config)
        env:
          CI: 1
        # compile the entire project to
        run: |
          npm run test:desktop -w salesforcedx-vscode-metadata -- --reporter=html

      - name: Upload Playwright HTML report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-desktop-${{ matrix.os }}
          path: packages/salesforcedx-vscode-metadata/playwright-report
          if-no-files-found: ignore

      - name: Upload Playwright Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results-desktop-${{ matrix.os }}
          path: packages/salesforcedx-vscode-metadata/test-results
          if-no-files-found: ignore

      - name: Cleanup scratch orgs
        if: always()
        continue-on-error: true
        shell: bash
        run: |
          sf org delete scratch -o "$DREAMHOUSE_ORG_ALIAS" --no-prompt || true
          sf org delete scratch -o "$MINIMAL_ORG_ALIAS" --no-prompt || true
