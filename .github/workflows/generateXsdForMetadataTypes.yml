name: Generate XSD for Metadata Types

on:
  workflow_dispatch:

jobs:
  generate-xsd:
    name: Generate XSD
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.ref }}

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Scrape all metadata pages
        run: npm run scrape:all:pages

      - name: Convert JSON to XSD
        run: npx ts-node scripts/jsonToXsdConverter.ts

      - name: Upload XSD artifact
        uses: actions/upload-artifact@v4
        with:
          name: salesforce_metadata_api_common.xsd
          path: packages/salesforcedx-vscode-core/resources/salesforce_metadata_api_common.xsd

      - name: Generate timestamp
        id: timestamp
        run: echo "value=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: 'chore: update salesforce_metadata_api_common.xsd (${{ steps.timestamp.outputs.value }})'
          title: 'chore: update Salesforce Metadata API XSD (${{ steps.timestamp.outputs.value }})'
          body: |
            This PR updates the `salesforce_metadata_api_common.xsd` file with the latest metadata type definitions.

            Generated by the [Generate XSD for Metadata Types](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) workflow at ${{ steps.timestamp.outputs.value }}.
          branch: automated/update-xsd-${{ steps.timestamp.outputs.value }}
          delete-branch: true
          add-paths: |
            packages/salesforcedx-vscode-core/resources/salesforce_metadata_api_common.xsd
