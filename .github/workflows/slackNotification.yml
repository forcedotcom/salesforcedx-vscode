name: Send Slack Notification

on:
  workflow_call:
    inputs:
      result:
        description: Result of the previous workflow
        type: string
      title:
        description: Title for the slack message
        type: string
      failedEvent:
        description: Name of the failed event
        type: string
      successfulEvent:
        description: URL for the successful event
        type: string
      notification:
        description: The message to be displayed for a notification.
        type: string
      type:
        description: Action type
        type: string
      workflow:
        description: Caller workflow
        type: string
      summary:
        description: Summary of e2e results
        type: string
      testsBranch:
        description: Branch from the E2E Automation Tests repo
        type: string
      vscodeVersion:
        description: VSCode version that the tests were run on
        type: string
    secrets:
      IDEE_RELEASE_SLACK_WEBHOOK:
        required: true
      IDEE_MAIN_SLACK_WEBHOOK:
        required: true
      IDEE_E2E_SLACK_WEBHOOK:
        required: true

jobs:
  notification_on_success:
    runs-on: ubuntu-latest
    if: inputs.result == 'success'
    steps:
      - name: Announce success
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.IDEE_RELEASE_SLACK_WEBHOOK }}
          webhook-type: incoming-webhook
          errors: true
          payload: |
            blocks:
              - type: header
                text:
                  type: plain_text
                  text: "${{ inputs.title }} — Success"
              - type: section
                fields:
                  - type: mrkdwn
                    text: "*Action:*\n${{ inputs.type }}"
                  - type: mrkdwn
                    text: "*Repository:*\n${{ github.event.repository.name }}"
              - type: section
                text:
                  type: mrkdwn
                  text: "<${{ inputs.successfulEvent }}|View workflow run>"

  notification_on_failure:
    runs-on: ubuntu-latest
    if: inputs.result == 'failure'
    steps:
      - name: Announce failure
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.IDEE_MAIN_SLACK_WEBHOOK }}
          webhook-type: incoming-webhook
          errors: true
          payload: |
            text: "${{ inputs.title }} — Failure: ${{ inputs.failedEvent }}"
            blocks:
              - type: header
                text:
                  type: plain_text
                  text: "${{ inputs.title }} — Failure"
              - type: section
                fields:
                  - type: mrkdwn
                    text: "*Action:*\n${{ inputs.type }}"
                  - type: mrkdwn
                    text: "*Repository:*\n${{ github.event.repository.name }}"
              - type: section
                text:
                  type: mrkdwn
                  text: "*Failure Event:*\n${{ inputs.failedEvent }}"
              - type: section
                text:
                  type: mrkdwn
                  text: "<${{ github.event.repository.html_url }}/actions/workflows/${{ inputs.workflow }}|View workflow run>"

  general_notification:
    runs-on: ubuntu-latest
    if: inputs.type == 'notification'
    steps:
      - name: General Notification
        continue-on-error: true
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.IDEE_MAIN_SLACK_WEBHOOK }}
          webhook-type: incoming-webhook
          errors: true
          payload: |
            text: "${{ inputs.title }}: ${{ inputs.notification }}"
            blocks:
              - type: header
                text:
                  type: plain_text
                  text: "${{ inputs.title }}"
              - type: section
                text:
                  type: mrkdwn
                  text: "${{ inputs.notification }}"
              - type: section
                text:
                  type: mrkdwn
                  text: "<${{ github.event.repository.html_url }}/actions/workflows/${{ inputs.workflow }}|View workflow run>"

  e2e_notification:
    runs-on: ubuntu-latest
    if: inputs.type == 'e2e'
    steps:
      - name: E2E Tests slack notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.IDEE_E2E_SLACK_WEBHOOK }}
          webhook-type: incoming-webhook
          errors: true
          payload: |
            text: "${{ inputs.title }} — ${{ inputs.result }}"
            blocks:
              - type: header
                text:
                  type: plain_text
                  text: "${{ inputs.title }}"
              - type: section
                fields:
                  - type: mrkdwn
                    text: "*Result:*\n${{ inputs.result }}"
                  - type: mrkdwn
                    text: "*VSCode Version:*\n${{ inputs.vscodeVersion }}"
                  - type: mrkdwn
                    text: "*Source Branch:*\n${{ github.ref_name }}"
                  - type: mrkdwn
                    text: "*Tests Branch:*\n${{ inputs.testsBranch }}"
              - type: section
                text:
                  type: mrkdwn
                  text: "*Summary:*\n${{ inputs.summary }}"
              - type: section
                text:
                  type: mrkdwn
                  text: "<${{ github.event.repository.html_url }}/${{ inputs.workflow }}|View workflow run>"
