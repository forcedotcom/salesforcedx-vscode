# E2E Test Failure Analysis Plan - PR 6779

**Branch:** `sm/e2e-non-tracking`

**Workflow Run:** 21106782558

**Date:** 2026-01-18

**Status:** Metadata E2E (Playwright) - FAILURE

## Summary

The Metadata E2E workflow is consistently failing on both macOS and Windows. The failures are related to:

1. Generate manifest command failing with TypeInferenceError
2. Deploy progress notifications not appearing
3. Status bar showing incorrect counts for non-tracking orgs

## Test Failures

### Windows Failures

#### 1. `deleteSource.headless.spec.ts` - "create and deploy apex class"

- **Error:** `Deploying progress notification should be visible`
- **Locator:** `.monaco-workbench .notification-list-item` filtered by `/Deploying/i`
- **Timeout:** 30000ms exceeded
- **Location:** Line 77 in `deleteSource.headless.spec.ts`
- **Screenshots:**
- `.e2e-artifacts/sm-e2e-non-tracking/21106782558-Metadata-E2E-Playwright/playwright-test-results-desktop-windows-latest/deleteSource.headless-Dele-116b7-and-org-via-command-palette-desktop-electron/test-failed-1.png`
- `.e2e-artifacts/sm-e2e-non-tracking/21106782558-Metadata-E2E-Playwright/playwright-test-results-desktop-windows-latest/deleteSource.headless-Dele-116b7-and-org-via-command-palette-desktop-electron-retry1/test-failed-1.png`
- `.e2e-artifacts/sm-e2e-non-tracking/21106782558-Metadata-E2E-Playwright/playwright-test-results-desktop-windows-latest/deleteSource.headless-Dele-116b7-and-org-via-command-palette-desktop-electron-retry2/test-failed-1.png`
- **Trace files:**
- `.e2e-artifacts/sm-e2e-non-tracking/21106782558-Metadata-E2E-Playwright/playwright-test-results-desktop-windows-latest/deleteSource.headless-Dele-116b7-and-org-via-command-palette-desktop-electron/trace.zip`
- **Pattern:** Test retried 3 times, all failed with same error. Deploy command executed but notification never appears.

#### 2. `deployManifest.headless.spec.ts` - "generate manifest from apex class"

- **Error:** `TimeoutError: locator.waitFor: Timeout 15000ms exceeded`
- **Locator:** `.monaco-editor[data-uri*="manifest/package.xml"]`
- **Timeout:** 15000ms exceeded
- **Location:** Line 92 in `deployManifest.headless.spec.ts`
- **Screenshots:**
- `.e2e-artifacts/sm-e2e-non-tracking/21106782558-Metadata-E2E-Playwright/playwright-test-results-desktop-windows-latest/deployManifest.headless-De-a5a2a-eploys-via-all-entry-points-desktop-electron/test-failed-1.png`
- `.e2e-artifacts/sm-e2e-non-tracking/21106782558-Metadata-E2E-Playwright/playwright-test-results-desktop-windows-latest/deployManifest.headless-De-a5a2a-eploys-via-all-entry-points-desktop-electron-retry1/test-failed-1.png`
- `.e2e-artifacts/sm-e2e-non-tracking/21106782558-Metadata-E2E-Playwright/playwright-test-results-desktop-windows-latest/deployManifest.headless-De-a5a2a-eploys-via-all-entry-points-desktop-electron-retry2/test-failed-1.png`
- **Error Context:** `.e2e-artifacts/sm-e2e-non-tracking/21106782558-Metadata-E2E-Playwright/playwright-test-results-desktop-windows-latest/deployManifest.headless-De-a5a2a-eploys-via-all-entry-points-desktop-electron/error-context.md`
- **Pattern:** Generate manifest command executed, but manifest editor never appears. Error context shows "Generate manifest failed:" alert visible in page snapshot.
- **Root Cause:** Console errors show `TypeInferenceError` and `FailedToBuildComponentSetError` when generating manifest.

#### Error Details:

The error occurs in the Extension Host and appears as:

```json
{
  "cause": {
    "name": "TypeInferenceError",
    "exitCode": 1
  },
  "_tag": "FailedToBuildComponentSetError"
}
```

**Error Location:**

- Extension Host console error
- Stack trace points to: `workbench.desktop.main.js:37` and `workbench.desktop.main.js:536`
- Error message: `Generate manifest failed:` (logged at `workbench.desktop.main.js:3867`)

**Error Pattern:**

- Error occurs consistently across all 3 retry attempts
- Happens when trying to generate manifest from Apex class `DeployManifestTest1768715558823.cls`
- The error happens during component set building phase (indicated by `FailedToBuildComponentSetError` tag)
- Type inference fails with exit code 1, suggesting the Apex language server or type checker is failing

**What this means:**

- The generate manifest command tries to build a component set from the active editor
- Building the component set requires type inference/analysis of the Apex class
- Type inference is failing (possibly due to missing org connection, language server not ready, or Apex class parsing issue)
- The failure is caught and wrapped in `FailedToBuildComponentSetError`
- The error is logged but the manifest file is never created, causing the test to timeout waiting for the editor

**Possible causes:**

1. Apex language server not fully initialized when manifest generation runs
2. Type inference requires org connection/context that isn't available
3. Apex class syntax issue preventing type inference
4. Race condition - manifest generation runs before language server is ready
5. Non-tracking org context may affect type inference capabilities

### macOS Failures

#### 1. `nonTrackingOrg.headless.spec.ts` - "Non-Tracking Org: deploy/retrieve operations work without tracking"

- **Error:** `Expected local=0, got 1`
- **Location:** Line 91 in `nonTrackingOrg.headless.spec.ts` (likely in a helper function checking status bar counts)
- **Pattern:** Status bar is showing local changes count of 1 when it should be 0 for a non-tracking org. This suggests the status bar widget is appearing when it shouldn't, or the counts are being tracked incorrectly.
- **Console Errors:** Network polling warnings (likely unrelated)
- **Screenshots:**
- `.e2e-artifacts/sm-e2e-non-tracking/21106782558-Metadata-E2E-Playwright/playwright-test-results-desktop-macos-latest/nonTrackingOrg.headless-No-484f9-king-UI-elements-are-hidden-desktop-electron/test-finished-1.png`
- Various screenshots in test-results directory

## Common Patterns

### 1. Generate Manifest Command Failing

- **Error:** `TypeInferenceError` with `FailedToBuildComponentSetError`
- **Occurrence:** Windows - deployManifest test
- **Symptom:** Command executes but fails silently, manifest file never created
- **Evidence:** Error context shows "Generate manifest failed:" alert in page snapshot

### 2. Deploy Progress Notifications Not Appearing

- **Error:** Notification locator timeout
- **Occurrence:** Windows - deleteSource test
- **Symptom:** Deploy command executed but progress notification never appears
- **Possible Causes:**
- Deploy failing silently before notification appears
- Notification selector incorrect
- Timing issue - notification appears/disappears too quickly

### 3. Status Bar Counts Incorrect for Non-Tracking Orgs

- **Error:** Status bar showing local=1 when should be 0
- **Occurrence:** macOS - nonTrackingOrg test
- **Symptom:** Status bar widget appearing or tracking changes when org is non-tracking
- **Possible Causes:**
- Status bar widget not properly hidden for non-tracking orgs
- Source tracking being enabled when it shouldn't be
- Count calculation logic not accounting for non-tracking orgs

## Root Cause Analysis

### Generate Manifest Failure

The generate manifest command is failing with `TypeInferenceError`. This is likely happening in the manifest generation code when trying to build a component set from the active editor. The error suggests:

- Type inference failing during component set building
- Possible issue with Apex class parsing/analysis
- May be related to non-tracking org context

**Files to investigate:**

- `packages/salesforcedx-vscode-metadata/src/commands/generateManifest.ts`
- Component set building logic

### Deploy Notification Not Appearing

The deploy command appears to execute but the progress notification never appears. This could mean:

- Deploy is failing immediately before notification appears
- Notification selector is incorrect
- Timing issue - need to check if deploy actually started

**Files to investigate:**

- `packages/playwright-vscode-ext/src/pages/notifications.ts` - `waitForDeployProgressNotificationToAppear`
- Deploy command execution flow

### Status Bar Counts for Non-Tracking Orgs

The status bar is showing counts when it shouldn't for non-tracking orgs. This suggests:

- Status bar widget visibility logic not working correctly
- Source tracking being enabled when org is non-tracking
- Count calculation happening even when tracking disabled

**Files to investigate:**

- `packages/salesforcedx-vscode-metadata/test/playwright/pages/sourceTrackingStatusBarPage.ts`
- Status bar visibility logic for non-tracking orgs

## Fix Plan

### Priority 1: Generate Manifest Error (Windows)

1. **Investigate TypeInferenceError**

- Check `generateManifest.ts` for error handling
- Review component set building logic
- Check if non-tracking org context affects manifest generation
- Add better error handling/logging

2. **Fix manifest generation**

- Ensure errors are surfaced properly
- Check if manifest generation should work differently for non-tracking orgs
- Verify Apex class parsing works correctly

3. **Update test expectations**

- If manifest generation fails, test should fail with clear error message
- Consider if test should skip manifest generation for non-tracking orgs

### Priority 2: Deploy Notification Not Appearing (Windows)

1. **Investigate deploy command execution**

- Check if deploy actually starts
- Review deploy command implementation
- Check output channel for deploy errors

2. **Fix notification waiting logic**

- Review `waitForDeployProgressNotificationToAppear` implementation
- Check notification selector
- Add better error messages if deploy fails before notification

3. **Add debugging**

- Capture output channel content when deploy fails
- Add screenshots at key points
- Check for error notifications that might appear instead

### Priority 3: Status Bar Counts for Non-Tracking Orgs (macOS)

1. **Investigate status bar visibility**

- Check if status bar should be hidden for non-tracking orgs
- Review status bar visibility logic
- Verify org context detection

2. **Fix count calculation**

- Ensure counts are not calculated for non-tracking orgs
- Check if source tracking is being enabled incorrectly
- Verify non-tracking org detection

3. **Update test**

- Ensure test properly waits for org context to be established
- Check if status bar should be completely hidden or just show 0 counts

## Test Artifacts

### HTML Reports

- macOS: `.e2e-artifacts/sm-e2e-non-tracking/21106782558-Metadata-E2E-Playwright/playwright-report-desktop-macos-latest/index.html`
- Windows: `.e2e-artifacts/sm-e2e-non-tracking/21106782558-Metadata-E2E-Playwright/playwright-report-desktop-windows-latest/index.html`
- Web: `.e2e-artifacts/sm-e2e-non-tracking/21106782558-Metadata-E2E-Playwright/playwright-report-web/index.html`

### Trace Files

- Windows deleteSource: `.e2e-artifacts/sm-e2e-non-tracking/21106782558-Metadata-E2E-Playwright/playwright-test-results-desktop-windows-latest/deleteSource.headless-Dele-116b7-and-org-via-command-palette-desktop-electron/trace.zip`
- Windows deployManifest: `.e2e-artifacts/sm-e2e-non-tracking/21106782558-Metadata-E2E-Playwright/playwright-test-results-desktop-windows-latest/deployManifest.headless-De-a5a2a-eploys-via-all-entry-points-desktop-electron/trace.zip`

### Screenshots

All screenshots are in:

- macOS: `.e2e-artifacts/sm-e2e-non-tracking/21106782558-Metadata-E2E-Playwright/playwright-test-results-desktop-macos-latest/`
- Windows: `.e2e-artifacts/sm-e2e-non-tracking/21106782558-Metadata-E2E-Playwright/playwright-test-results-desktop-windows-latest/`

## Next Steps

1. Review screenshots to understand visual state at failure points
2. Review trace files using `npx playwright show-trace <trace.zip>` to see step-by-step execution
3. Investigate generate manifest error - check if it's related to non-tracking org context
4. Check deploy command execution - verify if deploy actually starts
5. Review status bar logic for non-tracking orgs
6. Run tests locally to reproduce issues
7. Fix root causes identified
8. Re-run tests to verify fixes

## Related Files

- `packages/salesforcedx-vscode-metadata/src/commands/generateManifest.ts` - Generate manifest command
- `packages/salesforcedx-vscode-metadata/test/playwright/specs/nonTrackingOrg.headless.spec.ts` - Non-tracking org tests
- `packages/salesforcedx-vscode-metadata/test/playwright/specs/deleteSource.headless.spec.ts` - Delete source test
- `packages/salesforcedx-vscode-metadata/test/playwright/specs/deployManifest.headless.spec.ts` - Deploy manifest test
- `packages/playwright-vscode-ext/src/pages/notifications.ts` - Notification helpers
- `packages/salesforcedx-vscode-metadata/test/playwright/pages/sourceTrackingStatusBarPage.ts` - Status bar page object