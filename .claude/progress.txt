# E2E Test Progress

## Current Status
Working on fixing failing metadata e2e tests. Org-browser tests are passing (web and desktop on macOS).

## GitHub Actions Analysis (from run 20865969685 on sm/olly-and-per-ext-telemetry branch)
Windows Desktop Failures:
1. **deployManifest.headless.spec.ts** - Timeout waiting for source tracking status bar (60s timeout exceeded, page/context/browser closed)
2. **deployOnSave.headless.spec.ts** - "Deploying" progress notification not appearing (30s timeout)

## Commands Status

### Deploy Commands
1. `sf.project.deploy.start` - Has test: deploySourcePath.headless.spec.ts
2. `sf.project.deploy.start.ignore.conflicts` - TODO
3. `sf.deploy.source.path` - Has test: deploySourcePath*.spec.ts
4. `sf.deploy.active.editor` - TODO
5. `sf.deploy.in.manifest` - Has test: deployManifest.headless.spec.ts âŒ FAILING (Windows desktop)
6. Deploy on save - Has test: deployOnSave.headless.spec.ts âŒ FAILING (Windows desktop)

### Retrieve Commands
7. `sf.project.retrieve.start` - TODO
8. `sf.project.retrieve.start.ignore.conflicts` - TODO
9. `sf.retrieve.source.path` - TODO
10. `sf.retrieve.current.source.file` - TODO
11. `sf.retrieve.in.manifest` - TODO

### View Changes Commands
12. `sf.view.all.changes` - Has test: viewChangesCommands.headless.spec.ts
13. `sf.view.local.changes` - Has test: viewChangesCommands.headless.spec.ts
14. `sf.view.remote.changes` - Has test: viewChangesCommands.headless.spec.ts

### Source Tracking Commands
15. `sf.source.tracking.reset.remote` - TODO
16. Source tracking status bar - Has test: sourceTrackingStatusBar.headless.spec.ts

### Other Commands
17. `sf.apex.generate.class` - TODO
18. `sf.delete.source` - TODO
19. `sf.delete.source.current.file` - TODO

## Session Summary (Commit 5501e751f)

### Completed
1. âœ… Analyzed GitHub Actions failures from recent runs
2. âœ… Verified org-browser tests pass locally (web: 4/4 passed, desktop: 4/4 passed)
   - Tests are flaky on first run but pass on retry
3. âœ… Improved deployOnSave test approach:
   - Removed incorrect expectation of progress notifications
   - Deploy-on-save doesn't show UI notifications (by design)
   - Updated to verify completion via output channel
   - Matched actual service output messages

### Current Session (Commit TBD - sm/ralph-e2e-2)
- ðŸ” Investigated deployManifest.headless.spec.ts failures
- Root cause identified: Source tracking status bar not initializing in web mode
  - Tests using `createMinimalOrg()` fail: status bar never appears (120s timeout)
  - Switched to `createDreamhouseOrg()` which fixes status bar visibility
  - However: Source tracking counts remain 0â†“0â†‘ even after creating files
  - File creation in memfs doesn't trigger source tracking updates
- Testing matrix results:
  - **Web mode (macOS)**: ALL metadata tests fail - source tracking doesn't detect file changes
    - deployManifest: Status bar shows but counts don't update
    - sourceTrackingStatusBar: Remote changes = 0 (expected > 0 after Dreamhouse)
    - deploySourcePath: Status bar timeout with createMinimalOrg
  - **Desktop mode (macOS)**: deployManifest SKIPPED - uses right-click which doesn't work on Mac
  - **Windows desktop (CI)**: This is where the test actually runs and fails
- Changes made to deployManifest test:
  - Switched from `createMinimalOrg()` to `createDreamhouseOrg()`
  - Made count assertions relative to initial state instead of absolute values
  - Test now structured to handle variable initial counts from Dreamhouse
- Blocker: Cannot effectively test or fix source tracking issues on macOS
  - Web mode has fundamental source tracking limitations
  - Desktop mode test is intentionally skipped on Mac
  - Need Windows desktop environment to properly test/debug

### Key Findings
- Deploy-on-save operations intentionally don't show progress notifications
- Output messages include: "Deploy on save triggered (ignoreConflicts: ...)" and "Deploy on save complete: X succeeded"
- Tests should verify completion via output channel, not UI notifications
- Org-browser tests are stable with retry logic
